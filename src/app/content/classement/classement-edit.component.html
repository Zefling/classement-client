<loader-cmp *ngIf="!options" [message]="'gererator.loading' | translate"></loader-cmp>

<div drop-image [disabled]="dialogSaveServer?._open || editImage?._open || false">
    <h2>{{ 'gererator.title.' + (id ? 'edit' : 'new') | translate }}</h2>
    <div *ngIf="apiActive && classement && classement.templateTotal > 1">
        <button class="button-add primary" (click)="toTemplateNavigation()">
            {{ 'navigate.see.derivatives' | translate }} ({{ classement.templateTotal }})
        </button>
        <button class="button-add primary" (click)="showDerivative()" *ngIf="derivatives && derivatives.length > 1">
            {{ 'navigate.my.derivatives' | translate }} ({{ derivatives.length }})
        </button>
        <button class="button-add primary" (click)="showRankingDiff()">
            {{ 'gererator.ranking.diff' | translate }}
        </button>
    </div>

    <classement-options [options]="options" [lockCategory]="lockCategory"></classement-options>

    <div *ngIf="options" [ngClass]="classScreenMode" #div>
        <div class="classement-top">
            <h3>{{ 'gererator.ranking.group.title' | translate }}</h3>
            <button *ngIf="classScreenMode !== 'default'" (click)="screenMode('default', div)">
                {{ 'gererator.screen.default' | translate }}
            </button>
            <button *ngIf="classScreenMode !== 'enlarge'" (click)="screenMode('enlarge', div)">
                {{ 'gererator.screen.window' | translate }}
            </button>
            <button *ngIf="classScreenMode !== 'fullscreen'" (click)="screenMode('fullscreen', div)">
                {{ 'gererator.screen.fullscreen' | translate }}
            </button>
        </div>
        <div cdkDropListGroup>
            <table class="table-classement">
                <colgroup>
                    <col class="names" />
                    <col class="elements" />
                    <col class="actions" />
                </colgroup>
                <tbody>
                    <tr *ngFor="let group of groups; let indexGrp = index; let first = first; let last = last">
                        <td
                            class="names"
                            [style.--name-background]="group.bgColor + nameOpacity"
                            [style.--text-color]="group.txtColor"
                        >
                            <div>
                                <label class="name">
                                    <textarea
                                        autosize
                                        [(ngModel)]="group.name"
                                        (ngModelChange)="globalChange()"
                                        maxlength="500"
                                    ></textarea>
                                </label>

                                <span class="color txtColor icon-text-color" (click)="inputTxtColor.click()"></span>
                                <span class="color bgColor icon-background-color" (click)="inputBgColor.click()"></span>
                                <div class="colors">
                                    <input
                                        class="color"
                                        type="color"
                                        [(ngModel)]="group.bgColor"
                                        (ngModelChange)="globalChange()"
                                        #inputBgColor
                                    />
                                    <input
                                        class="color"
                                        type="color"
                                        [(ngModel)]="group.txtColor"
                                        (ngModelChange)="globalChange()"
                                        #inputTxtColor
                                    />
                                </div>
                            </div>
                        </td>
                        <td class="elements">
                            <div class="drop-list">
                                <div
                                    *ngFor="let item of group.list; let index = index"
                                    cdkDropList
                                    cdkDropListOrientation="horizontal"
                                    [cdkDropListData]="{ list: group.list, index: index }"
                                    (cdkDropListDropped)="drop(group.list, $event)"
                                >
                                    <div class="content-box" cdkDrag>
                                        <div
                                            class="content content-render"
                                            [ngClass]="options.itemTextPosition"
                                            [class.with-annotation]="item.annotation"
                                            #tile
                                            [style.width.px]="calcWidth(item, tile.querySelector('.title-span'))"
                                        >
                                            <div *ngIf="item.url" class="image">
                                                <img
                                                    (ngInit)="detectChanges()"
                                                    src="{{ item.url }}"
                                                    alt="{{ item.name }}"
                                                />
                                            </div>
                                            <div
                                                *ngIf="item.title"
                                                #title
                                                class="title"
                                                [class.title-item-width-auto]="options.itemWidthAuto"
                                            >
                                                <span class="title-span" (ngInit)="detectChanges()">{{
                                                    item.title
                                                }}</span>
                                            </div>
                                            <div class="tile-info" (click)="openTileInfo(item)"></div>
                                        </div>
                                    </div>
                                </div>
                                <div
                                    class="drop-zone-empty-list"
                                    *ngIf="group.list.length === 0"
                                    cdkDropList
                                    cdkDropListOrientation="horizontal"
                                    [cdkDropListData]="{ list: group.list, index: 0 }"
                                    (cdkDropListDropped)="drop(group.list, $event)"
                                ></div>
                            </div>
                        </td>
                        <td class="actions">
                            <div class="button-actions">
                                <button class="button-up" (click)="upLine(indexGrp)" *ngIf="!first">↑</button>
                                <button class="button-down" (click)="downLine(indexGrp)" *ngIf="!last">↓</button>
                                <button class="button-suppr" (click)="deleteLine(indexGrp)" *ngIf="!(first && last)">
                                    {{ 'gererator.line.delete' | translate }}
                                </button>
                                <button class="button-add" (click)="addLine(indexGrp)">
                                    {{ 'gererator.line.add' | translate }}
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div>
                <div class="drop-image-message">{{ 'gererator.ranking.drop.image' | translate }}</div>
                <div class="drop-list">
                    <div
                        *ngFor="let item of list; let index = index"
                        cdkDropList
                        cdkDropListOrientation="horizontal"
                        [cdkDropListData]="{ list: list, index: index }"
                        (cdkDropListDropped)="drop(list, $event)"
                    >
                        <div class="content-box" cdkDrag>
                            <div
                                class="content"
                                [class.with-annotation]="item.annotation"
                                [style.width.px]="
                                    options.itemWidthAuto
                                        ? ((item.width || 150) / (item.height || 150)) * options.itemHeight
                                        : null
                                "
                            >
                                <button class="btn-delete" (click)="removeItem(index)">×</button>
                                <img [src]="item.url" [alt]="item.name" />
                                <input
                                    class="input-title"
                                    input="text"
                                    maxlength="150"
                                    [(ngModel)]="item.title"
                                    (ngModelChange)="globalChange()"
                                    (blur)="change()"
                                />
                                <div class="tile-info" (click)="openTileInfo(item)"></div>
                            </div>
                        </div>
                    </div>
                    <div
                        class="drop-zone-empty-list"
                        *ngIf="list.length === 0"
                        cdkDropList
                        cdkDropListOrientation="horizontal"
                        [cdkDropListData]="{ list: list, index: 0 }"
                        (cdkDropListDropped)="drop(list, $event)"
                    ></div>
                    <div class="content-box add-file" (click)="addFiles()">
                        <span>{{ 'gererator.ranking.add.image' | translate }}</span>
                    </div>
                </div>
            </div>
        </div>

        <see-classement
            class="render"
            [options]="options"
            [groups]="groups"
            [list]="list"
            [withAnotation]="false"
            [imagesCache]="imagesCache"
        ></see-classement>
    </div>
    <div>
        <div class="save-actions buttons">
            <button class="primary" (click)="exportImage()" [disabled]="exportImageDisabled">
                <span *ngIf="!exportImageLoading" class="icon-share"></span>
                <loading-cmp size="22px" tickWidth="2px" *ngIf="exportImageLoading"></loading-cmp>
                {{ 'gererator.actions.export.image' | translate }}
            </button>
        </div>

        <div class="save-actions buttons">
            <button class="primary" (click)="saveLocal()" [disabled]="!hasItems">
                {{ 'gererator.actions.save.local' | translate }}
            </button>
            <button class="primary" (click)="saveJson()" [disabled]="!hasItems">
                {{ 'gererator.actions.export.json' | translate }}
            </button>
            <button class="primary" (click)="dialogImport.open()">
                {{ 'gererator.actions.import.json' | translate }}
            </button>
            <button class="primary" (click)="dialogOptimise.open()" [disabled]="size === 0">
                {{ 'gererator.optimise.button.optimise' | translate }} ({{ size | filesize }})
            </button>
            <label class="line" *ngIf="options && hasItems">
                <input type="checkbox" [(ngModel)]="options.autoSave" (ngModelChange)="globalChange()" />
                {{ 'gererator.actions.save.local.auto' | translate }}
            </label>
        </div>
        <div class="save-actions buttons" *ngIf="logged">
            <button [disabled]="!id" class="primary" (click)="copyLink()">
                🔗 {{ 'gererator.ranking.share.link' | translate }}
            </button>
            <button [disabled]="!id" class="primary" (click)="show()">
                {{ 'gererator.ranking.see' | translate }}
            </button>
            <button class="primary" (click)="saveServer()" [disabled]="!hasItems">
                {{ 'gererator.actions.save.server' | translate }}
            </button>
        </div>

        <div class="save-actions buttons">
            <button class="primary" (click)="dialogClear.open()" [disabled]="!hasItems">
                {{ 'gererator.actions.reset.groups.button' | translate }}
            </button>
        </div>
    </div>
</div>

<dialog-cmp class="auto-format" #dialogImage closeButton>
    <div class="button-image-save">
        {{ 'gererator.actions.save.image' | translate }}
        <span>
            <button class="button-add primary" (click)="saveImage('PNG')">PNG</button>
            <button class="button-add primary" (click)="saveImage('JPG')">Jpeg</button>
            <button class="button-add primary" (click)="saveImage('WEBP')">WebP</button>
        </span>
    </div>
    <div #image></div>
</dialog-cmp>

<dialog-cmp class="auto-format" #dialogImport>
    <import-json (load)="importJson($event)"></import-json>
</dialog-cmp>

<dialog-cmp class="auto-format" #dialogOptimise closeButton>
    <classement-optimise
        *ngIf="dialogOptimise._open"
        [list]="list"
        [groups]="groups"
        [dialog]="dialogOptimise"
    ></classement-optimise>
</dialog-cmp>

<dialog-cmp #dialogSaveServer>
    <classement-save-server
        *ngIf="logged && dialogSaveServer._open"
        [classement]="classement"
        [options]="options"
        [list]="list"
        [groups]="groups"
        [dialog]="dialogSaveServer"
        (save)="updateAfterServerSave($event)"
    ></classement-save-server>
</dialog-cmp>

<dialog-cmp #dialogDerivatives closeButton>
    <table class="table-derivatives" *ngIf="derivatives">
        <thead>
            <tr>
                <th class="title">{{ 'list.title.name' | translate }}</th>
                <th class="date">{{ 'list.date' | translate }}</th>
                <th class="groups">{{ 'list.count.group' | translate }}</th>
                <th class="items">{{ 'list.count.item' | translate }}</th>
                <th class="actions">{{ 'list.action.name' | translate }}</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let derivative of derivatives" [class.current]="derivative.rankingId === classement?.rankingId">
                <td class="title">
                    {{ derivative.data.options.title || ('list.title.undefined' | translate) }}
                    <ng-container *ngIf="derivative.rankingId === classement?.rankingId">
                        🢀 {{ 'list.current' | translate }}
                    </ng-container>
                </td>
                <td class="date">
                    <span>{{ derivative.dateCreate | date : ('date.dd/MM/yyyy' | translate) }}</span>
                    <span>{{ derivative.dateCreate | date : ('date.HH:mm' | translate) }}</span>
                </td>
                <td class="groups">{{ derivative.totalGroups }}</td>
                <td class="items">{{ derivative.totalItems }}</td>
                <td class="actions">
                    <a (click)="loadDerivativeClassement(derivative)">{{ 'list.action.replace' | translate }}</a>
                </td>
            </tr>
        </tbody>
    </table>
</dialog-cmp>

<dialog-cmp class="content-diff" #dialogRankingDiff>
    <div class="container">
        <ng-container *ngIf="diff?.length; else noTiles">
            <div class="label">
                {{ 'gererator.ranking.add.tile' | translate }}
            </div>
            <div class="elements drop-list">
                <div class="content-box" *ngFor="let item of diff" (click)="addTile(item)">
                    <div
                        class="content content-render"
                        [ngClass]="options.itemTextPosition"
                        [style.width.px]="
                            options.itemWidthAuto
                                ? ((item.width || 150) / (item.height || 150)) * options.itemHeight
                                : null
                        "
                    >
                        <div *ngIf="item.url" class="image">
                            <img src="{{ imagesCache[item.url] || item.url }}" alt="{{ item.name }}" />
                        </div>
                        <div *ngIf="item.title" class="title">
                            <span>{{ item.title }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </ng-container>
        <ng-template #noTiles>
            <div class="content-diff">{{ 'gererator.ranking.no.tile' | translate }}</div>
        </ng-template>
        <div class="buttons">
            <button class="primary" (click)="dialogRankingDiff.close()">
                {{ 'gererator.ranking.close' | translate }}
            </button>
        </div>
    </div>
</dialog-cmp>

<dialog-cmp class="auto-format" #dialogClear>
    <p>
        {{ 'gererator.actions.reset.groups.question' | translate }}
    </p>
    <div class="buttons">
        <button (click)="dialogClear.close()">
            {{ 'gererator.actions.reset.groups.cancel' | translate }}
        </button>
        <button class="warn" (click)="reset(); dialogClear.close()">
            {{ 'gererator.actions.reset.groups.ok' | translate }}
        </button>
    </div>
</dialog-cmp>

<classement-edit-image [currentTile]="currentTile" #editImage></classement-edit-image>
